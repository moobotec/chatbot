<!doctype html>
<html lang="fr">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot AIML - Page de Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=Zilla+Slab:wght@400;600&display=swap");

      :root {
        --night: #0b1220;
        --nebula: #111a2b;
        --mist: #e6f0ff;
        --ink: #0e1423;
        --accent: #3a7bd5;
        --accent-2: #7a4dff;
        --card: #ffffff;
        --shadow: 0 20px 45px rgba(8, 16, 32, 0.18);
      }

      body {
        font-family: "Space Grotesk", system-ui, -apple-system, sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 20% 10%, rgba(122, 77, 255, 0.22), transparent 45%),
          radial-gradient(circle at 80% 0%, rgba(58, 123, 213, 0.22), transparent 40%),
          radial-gradient(circle at 50% 100%, rgba(14, 20, 35, 0.5), transparent 55%),
          var(--night);
        min-height: 100vh;
      }

      .hero-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(246, 248, 255, 0.98));
        border-radius: 28px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(6px);
      }

      .brand-tag {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(58, 123, 213, 0.12);
        color: var(--mist);
        font-weight: 600;
        font-size: 0.85rem;
        letter-spacing: 0.4px;
      }

      .title {
        font-family: "Zilla Slab", "Georgia", serif;
        font-weight: 600;
        font-size: clamp(2.2rem, 4vw, 3.2rem);
        color: #f8f9ff;
      }

      .subtitle {
        color: rgba(230, 240, 255, 0.75);
        max-width: 680px;
      }

      .chat-surface {
        border-radius: 22px;
        background: var(--card);
        box-shadow: var(--shadow);
        border: 1px solid rgba(15, 23, 42, 0.08);
      }

      .chat-log {
        min-height: 180px;
        height: clamp(220px, 35vh, 360px);
        max-height: 360px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        overflow-y: auto;
        background: linear-gradient(180deg, #f9fbff 0%, #ffffff 100%);
      }

      .chat-body {
        min-height: 0;
      }

      .bubble {
        width: fit-content;
        max-width: min(70%, 520px);
        line-height: 1.4;
        position: relative;
        white-space: pre-wrap;
        word-break: break-word;
      }

      .bubble.user {
        margin-left: auto;
        border-bottom-right-radius: 0.4rem;
      }

      .bubble.bot {
        border-bottom-left-radius: 0.4rem;
      }

      .glow-btn {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        border: none;
        box-shadow: 0 12px 25px rgba(58, 123, 213, 0.35);
      }

      .meta-card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 20px;
        box-shadow: var(--shadow);
        border: 1px solid rgba(255, 255, 255, 0.4);
      }

      .fade-up {
        animation: fadeUp 0.7s ease both;
      }

      @keyframes fadeUp {
        from {
          opacity: 0;
          transform: translateY(12px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
  </head>
  <body>
    <main class="container py-5">
      <header class="mb-4 mb-lg-5 fade-up">
        <span class="brand-tag">REBECCA • AIML LAB</span>
        <h1 class="title mt-3">Rebecca Chatbot · Interface de Test</h1>
        <p class="subtitle mt-2">
          Cette page sert de laboratoire rapide pour envoyer des messages et observer
          les réponses du chatbot. Elle est volontairement simple pour faciliter
          les essais et les itérations.
        </p>
      </header>

      <section class="chat-surface p-3 p-lg-4 fade-up" aria-label="Zone de test du chatbot">
        <div class="d-flex flex-column gap-3 chat-body">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <label class="form-label mb-0 fw-semibold" for="languageSelect">Langue</label>
            <select class="form-select w-auto" id="languageSelect" aria-label="Sélecteur de langue">
              <option value="fr" selected>Français</option>
              <option value="en">English</option>
            </select>
            <button
              class="btn btn-outline-secondary btn-sm ms-auto"
              type="button"
              id="resetChatBtn"
            >
              Reset conversation
            </button>
          </div>
          <div class="chat-log border rounded-4 p-3" id="chatLog" aria-live="polite">
            <div class="bubble bot bg-warning-subtle text-dark px-3 py-2 rounded-4">
              Bonjour, je suis prêt pour un test. Posez-moi une question.
            </div>
          </div>
          <form id="chatForm" class="d-grid gap-2">
            <label class="form-label mb-0" for="message" id="messageLabel">Votre message</label>
            <textarea
              class="form-control"
              id="message"
              name="message"
              rows="3"
              placeholder="Écrivez ici..."
            ></textarea>
            <button class="btn glow-btn text-white rounded-pill px-4" type="submit">
              Envoyer un message
            </button>
          </form>
        </div>
      </section>

    

      <section class="meta-card p-3 p-lg-4 mt-4 fade-up" aria-label="Statistiques AIML">
        <div class="d-grid gap-2">
          <div class="fw-semibold text-dark" id="statsTitle">Statistiques AIML</div>
          <div class="text-secondary" id="statsSummary">Chargement...</div>
          <div class="text-secondary" id="statsDetail"></div>
        </div>
      </section>

      <section class="meta-card p-3 p-lg-4 mt-4 fade-up" aria-label="Informations de source">
        <div class="d-grid gap-2 text-secondary">
           <div>
            <span class="fw-semibold text-dark">Version du projet :</span>
            <span>v0.0.1</span>
          </div>
          <div>
            <span class="fw-semibold text-dark">Origine du projet :</span>
            <a class="link-primary" href="https://rebecca-aiml.sourceforge.net/download.htm">
              RebeccaAIML-src-9871
            </a>
          </div>
          <div>
            <span class="fw-semibold text-dark">Source AIML (FR) :</span>
            <a class="link-primary" href="https://github.com/aifr/aimlfr?utm_source=chatgpt.com">
              GitHub / aimlfr
            </a>
          </div>
        </div>
      </section>

    </main>

    <script>
      const languageSelect = document.getElementById("languageSelect");
      const form = document.getElementById("chatForm");
      const messageInput = document.getElementById("message");
      const messageLabel = document.getElementById("messageLabel");
      const chatLog = document.getElementById("chatLog");
      const submitButton = form.querySelector("button");
      const resetChatBtn = document.getElementById("resetChatBtn");
      const statsTitle = document.getElementById("statsTitle");
      const statsSummary = document.getElementById("statsSummary");
      const statsDetail = document.getElementById("statsDetail");

      const CHAT_ENDPOINT = "./chatbot/chat.php";
      const STATS_ENDPOINT = "./chatbot/stats.php";

      const uiText = {
        fr: {
          greeting: "Bonjour, je suis prêt pour un test. Posez-moi une question.",
          label: "Votre message",
          placeholder: "Écrivez ici...",
          button: "Envoyer un message",
          waiting: "Envoi en cours...",
          simulated:
            "Réponse simulée. Branchez ici votre logique AIML pour obtenir une vraie réponse.",
          error: "Erreur lors de l'appel au chatbot.",
          statsTitle: "Statistiques AIML",
          statsLoading: "Chargement...",
          statsTotal: "Total",
          statsLang: "Langue sélectionnée",
          statsFiles: "fichiers",
          statsCategories: "catégories",
        },
        en: {
          greeting: "Hello, I'm ready for a test. Ask me a question.",
          label: "Your message",
          placeholder: "Type here...",
          button: "Send message",
          waiting: "Sending...",
          simulated:
            "Simulated reply. Connect your AIML logic here to get a real response.",
          error: "Error while calling the chatbot.",
          statsTitle: "AIML stats",
          statsLoading: "Loading...",
          statsTotal: "Total",
          statsLang: "Selected language",
          statsFiles: "files",
          statsCategories: "categories",
        },
      };

      function resetChatUi(lang) {
        const text = uiText[lang] || uiText.fr;
        chatLog.innerHTML = "";
        appendBubble(text.greeting, "bot");
      }

      function applyLanguage(lang) {
        const text = uiText[lang] || uiText.fr;
        messageLabel.textContent = text.label;
        messageInput.placeholder = text.placeholder;
        submitButton.textContent = text.button;
        statsTitle.textContent = text.statsTitle;
        statsSummary.textContent = text.statsLoading;
        statsDetail.textContent = "";
      }

      async function loadStats() {
        const lang = languageSelect.value;
        const text = uiText[lang] || uiText.fr;
        statsSummary.textContent = text.statsLoading;
        statsDetail.textContent = "";
        try {
          const res = await fetch(STATS_ENDPOINT, { credentials: "same-origin" });
          if (!res.ok) throw new Error("stats");
          const data = await res.json();
          const total = data.total || { files: 0, categories: 0 };
          const langStats = (data.langs && data.langs[lang]) || { files: 0, categories: 0 };
          statsSummary.textContent =
            `${text.statsTotal}: ${total.files} ${text.statsFiles}, ${total.categories} ${text.statsCategories}`;
          statsDetail.textContent =
            `${text.statsLang} (${lang.toUpperCase()}): ${langStats.files} ${text.statsFiles}, ` +
            `${langStats.categories} ${text.statsCategories}`;
        } catch (error) {
          statsSummary.textContent = text.error;
        }
      }

      async function resetSession(lang) {
        const csrf = await fetchCsrfToken();
        const body = new URLSearchParams({
          lang,
          reset: "1",
          csrf,
        });
        await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body: body.toString(),
          credentials: "same-origin",
        });
      }

      languageSelect.addEventListener("change", async (event) => {
        const lang = event.target.value;
        applyLanguage(lang);
        resetChatUi(lang);
        try {
          await resetSession(lang);
        } catch (error) {
          // Ignore reset errors to keep UI responsive.
        }
        loadStats();
      });

      resetChatBtn.addEventListener("click", async () => {
        const lang = languageSelect.value;
        resetChatUi(lang);
        try {
          await resetSession(lang);
        } catch (error) {
          // Ignore reset errors to keep UI responsive.
        }
      });

      applyLanguage(languageSelect.value);
      resetChatUi(languageSelect.value);
      loadStats();

      async function fetchCsrfToken() {
        const res = await fetch(`${CHAT_ENDPOINT}?action=token`, {
          credentials: "same-origin",
        });
        if (!res.ok) {
          throw new Error("token");
        }
        const data = await res.json();
        return data.token;
      }

      async function sendMessage(message, lang) {
        const csrf = await fetchCsrfToken();
        const body = new URLSearchParams({
          message,
          lang,
          csrf,
        });
        const res = await fetch(CHAT_ENDPOINT, {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8",
          },
          body: body.toString(),
          credentials: "same-origin",
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          const error = data.error || "request";
          throw new Error(error);
        }
        return data.reply || "";
      }

      function appendBubble(text, type) {
        const bubble = document.createElement("div");
        bubble.className =
          type === "user"
            ? "bubble user bg-info-subtle text-dark px-3 py-2 rounded-4"
            : "bubble bot bg-warning-subtle text-dark px-3 py-2 rounded-4";
        bubble.textContent = text;
        chatLog.appendChild(bubble);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      form.addEventListener("submit", async (event) => {
        event.preventDefault();
        const text = messageInput.value.trim();
        if (!text) return;

        const lang = languageSelect.value;
        const textPack = uiText[lang] || uiText.fr;

        appendBubble(text, "user");
        submitButton.disabled = true;
        submitButton.textContent = textPack.waiting;

        try {
          const reply = await sendMessage(text, lang);
          appendBubble(reply || textPack.simulated, "bot");
        } catch (error) {
          appendBubble(textPack.error, "bot");
        } finally {
          submitButton.disabled = false;
          submitButton.textContent = textPack.button;
        }

        messageInput.value = "";
      });
    </script>
  </body>
</html>
